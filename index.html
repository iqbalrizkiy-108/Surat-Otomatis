<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generator Surat Profesional — Otomatis (PDF + TTD + Barcode)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    footer.app-footer {
  margin-top: 40px;
  padding: 25px;
  text-align: center;
  background: rgba(255,255,255,0.03);
  border-top: 1px solid rgba(255,255,255,0.08);
  border-radius: 12px;
  color: #9aa4b2;
  font-size: 14px;
}

.footer-icons {
  margin-top: 12px;
  display: flex;
  justify-content: center;
  gap: 20px;
}

.footer-icons a {
  color: #9aa4b2;
  font-size: 22px;
  transition: 0.25s ease;
}

.footer-icons a:hover {
  color: #4f46e5;
  transform: scale(1.2);
}

   
    

    select {
  color: #111;              /* Warna teks agar terlihat */
  background: #ffffff;      /* Background terang */
  border: 1px solid #d2d2d2;
}

select option {
  color: #111;
  background: #ffffff;         /* Background dropdown jelas terlihat */
}

  :root{
    --bg-1: #0f1724;
    --accent: #4f46e5;
    --muted: #9aa4b2;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, Arial, sans-serif;
    background: radial-gradient(circle at 10% 10%, #071024 0%, #0f1724 60%);
    color:#ffffff;
    padding:28px;
  }

  .app {
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns: 480px 1fr;
    gap:28px;
    align-items:start;
  }

  .card {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    padding:20px;
    box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.04);
  }

  h1{font-size:20px;margin:0 0 8px 0}
  p.lead{color:var(--muted);margin:0 0 16px 0;font-size:13px}

  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
  input[type="text"], input[type="date"], textarea, select{
    width:100%;padding:10px;border-radius:8px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:#eaf2ff;
  }
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:12px}
  .row .col{flex:1}
  .small{font-size:12px;color:var(--muted);margin-top:6px}

  .btn {
    display:inline-block;padding:10px 14px;background:linear-gradient(90deg,var(--accent),#7c3aed);
    color:rgb(255, 255, 255);border-radius:10px;border:none;cursor:pointer;font-weight:600;
    box-shadow: 0 6px 18px rgba(79,70,229,0.14);
  }
  .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#ffffff}
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04);}

  .sig-area{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:8px;padding:10px;margin-top:10px}
  canvas#sigpad{display:block;width:100%;height:160px;border-radius:6px;background:#fff}

  .preview {
    padding:26px;
    border-radius:12px;
    background:linear-gradient(180deg,#ffffff 0%, #fbfdff 100%);
    color:#0b1320;
    min-height:720px;
    box-shadow: 0 10px 40px rgba(2,6,23,0.25);
    overflow:auto;
  }

  .letter{
    max-width:780px;margin:0 auto;padding:28px;background:white;border-radius:6px;border:1px solid #eee;
    font-family: Georgia, "Times New Roman", serif;color:#111;line-height:1.6;
  }
  .letter h2{margin:0 0 6px 0;font-size:18px}
  .letter .meta{font-size:13px;color:#444;margin-bottom:14px}
  .letter .body{white-space:pre-wrap;font-size:15px;color:#222}
  .meta-row{display:flex;justify-content:space-between;margin-bottom:12px}

  .barcode{
    width:220px;height:56px;border:1px solid #ddd;padding:6px;background:#fff;display:inline-block;
  }

  footer.small{font-size:12px;color:#666;margin-top:18px}

  @media (max-width:980px){
    .app{grid-template-columns:1fr; padding:10px}
    .preview{min-height:480px}
  }
</style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>Generator Surat Profesional</h1>
    <p class="lead">Pilih template, isi data, tandatangani digital, lalu unduh PDF otomatis (file akan didownload).</p>

    <label>Template Surat</label>
    <select id="template">
      <!-- Original options plus many template choices (Pilihan A) -->
      <option value="formal">Formal - Surat Resmi</option>
      <option value="company">Perusahaan - HR / Internal</option>
      <option value="org">Organisasi - Pengajuan Kegiatan</option>

      <optgroup style="color: #071024;" label="Berdasarkan Tujuan">
        <option value="surat_dinas">Surat Dinas (Surat Tugas / Keputusan)</option>
        <option value="surat_niaga">Surat Niaga / Komersial (Penawaran / Faktur)</option>
        <option value="surat_pribadi">Surat Pribadi</option>
        <option value="surat_pemerintahan">Surat Resmi Pemerintahan</option>
      </optgroup>

      <optgroup style="color: #071024;" label="Berdasarkan Bentuk / Format">
        <option value="surat_resmi">Surat Resmi (Kop, Nomor, Perihal)</option>
        <option value="surat_tidak_resmi">Surat Tidak Resmi</option>
        <option value="surat_kabar">Surat Kabar / Siaran Pers</option>
      </optgroup>

      <optgroup style="color: #071024;" label="Berdasarkan Isi">
        <option value="surat_undangan">Surat Undangan</option>
        <option value="surat_pemberitahuan">Surat Pemberitahuan / Pengumuman</option>
        <option value="surat_permohonan">Surat Permohonan / Permintaan</option>
        <option value="surat_perjanjian">Surat Perjanjian / Kontrak</option>
        <option value="surat_keputusan">Surat Keputusan</option>
      </optgroup>
    </select>

    <div style="height:12px"></div>

    <label>Nama Lengkap</label>
    <input type="text" id="inputNama" placeholder="Nama lengkap" value="Budi Santoso">

    <div class="row">
      <div class="col">
        <label>Jabatan / Posisi</label>
        <input type="text" id="inputJabatan" placeholder="Contoh: Staff IT" value="Staff IT">
      </div>
      <div class="col">
        <label>Tanggal</label>
        <input type="date" id="inputTanggal">
      </div>
    </div>

    <label>Alamat / Institusi</label>
    <input type="text" id="inputAlamat" placeholder="Alamat atau institusi" value="Jl. Merdeka No.1">

    <label>Judul / Keperluan Surat</label>
    <input type="text" id="inputKeperluan" placeholder="Contoh: Permohonan Cuti" value="Permohonan Cuti">

    <label>Isi Ringkas</label>
    <textarea id="inputIsi" placeholder="Jelaskan singkat tujuan surat">Dengan hormat, saya mengajukan cuti selama 3 hari karena keperluan keluarga.</textarea>

    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button class="btn" id="btnGenerate">Generate Preview</button>
      <button class="btn" id="btnExportPDF">Export PDF Otomatis</button>
      <button class="btn secondary" id="btnDownloadManual">Download PDF (Manual)</button>
      <button class="btn ghost" id="btnReset">Reset</button>
    </div>

    <hr style="margin:14px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

    <h3 style="margin:6px 0 6px 0">Tanda Tangan Digital</h3>
    <p class="small">Gambar tanda tangan di bawah lalu klik "Gunakan" agar muncul di surat.</p>
    <div class="sig-area">
      <canvas id="sigpad" width="420" height="160"></canvas>
      <div style="margin-top:8px;display:flex;gap:8px;">
        <button class="btn secondary" id="btnSigClear">Bersihkan</button>
        <button class="btn" id="btnSigUse">Gunakan Tanda Tangan</button>
      </div>
    </div>

    <div style="height:12px"></div>
    <label>Kode Verifikasi (opsional)</label>
    <input type="text" id="verifInput" placeholder="Biarkan kosong agar tidak tampil">

    <div style="height:8px"></div>
    <label>Penerbit / Diterbitkan oleh (opsional)</label>
    <input type="text" id="publisherInput" placeholder="Misal: Bagian Administrasi PT Maju Jaya">

    <p class="small">Sistem menghasilkan barcode verifikasi (CODE128) yang dicetak di surat jika diisi.</p>
  </div>

  <div class="card preview" id="previewArea">
    <div id="letterContainer" class="letter">
      <div class="meta-row">
        <div>
          <h2 id="letterTitle">SURAT PERMOHONAN</h2>
          <div class="meta" id="letterMeta">Nomor: - &nbsp; | &nbsp; Tanggal: -</div>
        </div>
        <div style="text-align:right">
          <svg id="barcodeSvg" class="barcode"></svg>
          <div class="small" id="verifText"></div>
        </div>
      </div>

      <div id="letterBody" class="body">
        Tekan "Generate Preview" untuk melihat hasil surat.
      </div>

      <div id="signatureWrap" style="margin-top:24px;display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="small">Hormat saya,</div>
          <div style="height:60px"></div>
          <div id="signImageLabel" style="font-weight:700;color:#111"></div>
        </div>
        <div style="text-align:right">
          <div class="small" id="issuedByPreview" style="color:#444"></div>
          <div class="small" id="issuedAt"></div>
        </div>
      </div>

      <footer class="small">Simpan kode verifikasi untuk pengecekan dokumen.</footer>
    </div>
  </div>
</div>

<footer class="app-footer">
  <div>© 2025 Generator Surat Profesional — Semua Hak Dilindungi</div>
  <h3>Iqbal | Nazril</h3>

  <div class="footer-icons">
    <!-- Facebook -->
    <a href="https://facebook.com" target="_blank" aria-label="Facebook">
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path d="M22 12.07C22 6.48 17.52 2 12 2S2 6.48 2 12.07c0 5 3.66 9.13 8.44 9.93v-7.02H7.9v-2.91h2.54V9.41c0-2.5 1.49-3.89 3.78-3.89 1.1 0 2.24.2 2.24.2v2.47h-1.26c-1.24 0-1.63.77-1.63 1.56v1.87h2.78l-.44 2.91h-2.34v7.02C18.34 21.2 22 17.07 22 12.07z"/>
      </svg>
    </a>

    <!-- Instagram -->
    <a href="https://instagram.com" target="_blank" aria-label="Instagram">
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path d="M7 2C4.24 2 2 4.24 2 7v10c0 2.76 2.24 5 5 5h10c2.76 0 5-2.24 5-5V7c0-2.76-2.24-5-5-5H7zm10 2c1.65 0 3 1.35 3 3v10c0 1.65-1.35 3-3 3H7c-1.65 0-3-1.35-3-3V7c0-1.65 1.35-3 3-3h10zm-5 3.5A4.5 4.5 0 1 0 16.5 12 4.505 4.505 0 0 0 12 7.5zm0 7.4A2.9 2.9 0 1 1 14.9 12 2.9 2.9 0 0 1 12 14.9zm4.8-8.86a1.08 1.08 0 1 1-1.08-1.08 1.08 1.08 0 0 1 1.08 1.08z"/>
      </svg>
    </a>

    <!-- GitHub -->
    <a href="https://github.com" target="_blank" aria-label="GitHub">
      <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 .5A11.5 11.5 0 0 0 .5 12c0 5.08 3.29 9.39 7.86 10.91.58.1.79-.25.79-.56v-2c-3.2.7-3.87-1.39-3.87-1.39-.53-1.33-1.3-1.68-1.3-1.68-1.06-.73.08-.72.08-.72 1.17.08 1.79 1.2 1.79 1.2 1.04 1.79 2.73 1.27 3.4.97.1-.76.41-1.27.74-1.56-2.55-.29-5.23-1.28-5.23-5.7 0-1.26.45-2.3 1.2-3.11-.12-.29-.52-1.46.11-3.05 0 0 .97-.31 3.18 1.18a10.9 10.9 0 0 1 5.8 0c2.22-1.49 3.18-1.18 3.18-1.18.63 1.59.23 2.76.11 3.05.75.81 1.2 1.85 1.2 3.11 0 4.44-2.69 5.41-5.25 5.69.42.36.8 1.08.8 2.18v3.24c0 .31.21.67.8.56A11.52 11.52 0 0 0 23.5 12 11.5 11.5 0 0 0 12 .5z"/>
      </svg>
    </a>
  </div>
</footer>


<!-- Libraries: JsBarcode + html2pdf (bundle includes html2canvas + jspdf) -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
/* ----------------------
   Signature pad (simple)
   ---------------------- */
const sigCanvas = document.getElementById('sigpad');
const sigCtx = sigCanvas.getContext('2d');
let drawing=false, lastX=0, lastY=0;
sigCtx.strokeStyle = "#111"; sigCtx.lineWidth = 2.5; sigCtx.lineCap = "round";

function startDraw(e){ drawing=true; const p = pos(e); lastX=p.x; lastY=p.y; }
function draw(e){ if(!drawing) return; const p=pos(e); sigCtx.beginPath(); sigCtx.moveTo(lastX,lastY); sigCtx.lineTo(p.x,p.y); sigCtx.stroke(); lastX=p.x; lastY=p.y; }
function stopDraw(){ drawing=false; }
function pos(e){ const r = sigCanvas.getBoundingClientRect(); const clientX = e.touches ? e.touches[0].clientX : e.clientX; const clientY = e.touches ? e.touches[0].clientY : e.clientY; return {x: clientX - r.left, y: clientY - r.top}; }

sigCanvas.addEventListener('mousedown', startDraw);
sigCanvas.addEventListener('mousemove', draw);
sigCanvas.addEventListener('mouseup', stopDraw);
sigCanvas.addEventListener('mouseout', stopDraw);
sigCanvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); startDraw(e); }, {passive:false});
sigCanvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); draw(e); }, {passive:false});
sigCanvas.addEventListener('touchend', stopDraw);

/* make canvas white background initially */
(function fillWhite(){
  sigCtx.fillStyle='#fff'; sigCtx.fillRect(0,0,sigCanvas.width,sigCanvas.height);
})();

/* controls */
const btnSigClear = document.getElementById('btnSigClear');
const btnSigUse = document.getElementById('btnSigUse');
const btnGenerate = document.getElementById('btnGenerate');
const btnExportPDF = document.getElementById('btnExportPDF');
const btnDownloadManual = document.getElementById('btnDownloadManual');
const btnReset = document.getElementById('btnReset');

const inputNama = document.getElementById('inputNama');
const inputJabatan = document.getElementById('inputJabatan');
const inputTanggal = document.getElementById('inputTanggal');
const inputAlamat = document.getElementById('inputAlamat');
const inputKeperluan = document.getElementById('inputKeperluan');
const inputIsi = document.getElementById('inputIsi');
const templateEl = document.getElementById('template');
const verifInput = document.getElementById('verifInput');
const publisherInput = document.getElementById('publisherInput');

const letterTitle = document.getElementById('letterTitle');
const letterMeta = document.getElementById('letterMeta');
const letterBody = document.getElementById('letterBody');
const barcodeSvg = document.getElementById('barcodeSvg');
const verifText = document.getElementById('verifText');
const signImageLabel = document.getElementById('signImageLabel');
const issuedAt = document.getElementById('issuedAt');
const issuedByPreview = document.getElementById('issuedByPreview');

let lastSignatureDataURL = null;

btnSigClear.addEventListener('click', ()=>{
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  sigCtx.fillStyle='#fff'; sigCtx.fillRect(0,0,sigCanvas.width,sigCanvas.height);
  lastSignatureDataURL = null;
  signImageLabel.innerHTML = '';
});

btnSigUse.addEventListener('click', ()=>{
  const dataURL = sigCanvas.toDataURL('image/png');
  // check non-white
  const img = new Image();
  img.onload = ()=>{
    const c = document.createElement('canvas'); c.width=img.width; c.height=img.height;
    const ctx = c.getContext('2d'); ctx.drawImage(img,0,0);
    const data = ctx.getImageData(0,0,c.width,c.height).data;
    let nonwhite=false; for(let i=0;i<data.length;i+=4){ if(!(data[i]===255 && data[i+1]===255 && data[i+2]===255)){ nonwhite=true; break; } }
    if(!nonwhite){ alert('Tanda tangan kosong. Silakan gambar terlebih dahulu.'); return; }
    lastSignatureDataURL = dataURL;
    signImageLabel.innerHTML = '<img src="'+dataURL+'" style="max-width:220px;max-height:90px;border:1px solid #ddd">';
    alert('Tanda tangan tersimpan. Tekan Generate Preview untuk melihat pada surat.');
  };
  img.src = dataURL;
});

btnReset.addEventListener('click', ()=>{ 
  if(!confirm('Reset semua isian?')) return;
  inputNama.value=''; inputJabatan.value=''; inputTanggal.value='';
  inputAlamat.value=''; inputKeperluan.value=''; inputIsi.value='';
  verifInput.value=''; publisherInput.value='';
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  sigCtx.fillStyle='#fff'; sigCtx.fillRect(0,0,sigCanvas.width,sigCanvas.height);
  lastSignatureDataURL = null;
  signImageLabel.innerHTML = '';
  generatePreview();
});

btnGenerate.addEventListener('click', generatePreview);

async function generatePreview(){
  const name = inputNama.value.trim() || '[Nama]';
  const jab = inputJabatan.value.trim() || '-';
  const tglRaw = inputTanggal.value ? new Date(inputTanggal.value) : new Date();
  const tgl = formatDate(tglRaw);
  const alamat = inputAlamat.value.trim() || '-';
  const keperluan = inputKeperluan.value.trim() || '-';
  const isi = inputIsi.value.trim() || '-';
  const tpl = templateEl.value;

  // set title by category (keeps original behaviour for a few)
  let title = 'SURAT PERMOHONAN';
  if(tpl==='company') title = 'SURAT INTERNAL PERUSAHAAN';
  if(tpl==='org') title = 'SURAT PENGAJUAN KGIATAN';

  // set default number & meta
  letterTitle.textContent = title;
  const nomor = generateNomor();
  letterMeta.textContent = `Nomor: ${nomor} | Tanggal: ${tgl}`;

  // Build body based on selected template (added templates from request)
  let body = '';

  switch(tpl){
    // existing ones
    case 'formal':
      body = `Kepada Yth.\nPimpinan Instansi yang terkait\nDi Tempat\n\nDengan hormat,\n\nSaya yang bertanda tangan di bawah ini:\nNama\t: ${name}\nJabatan : ${jab}\nAlamat\t: ${alamat}\n\nBermaksud mengajukan: ${keperluan}\n\n${isi}\n\nDemikian permohonan ini saya sampaikan. Atas perhatian dan persetujuan Bapak/Ibu, saya ucapkan terima kasih.`;
      break;
    case 'company':
      body = `Kepada Yth.\nHRD / Manajemen\nDi Tempat\n\nDengan hormat,\n\nNama\t\t: ${name}\nPosisi\t\t: ${jab}\nDepartemen\t: ${alamat}\n\nPerihal: ${keperluan}\n\n${isi}\n\nDemikian untuk menjadi perhatian.`;
      break;
    case 'org':
      body = `Kepada Pengurus Organisasi / Panitia,\n\nDengan hormat,\n\nNama\t: ${name}\nPosisi\t: ${jab}\nOrganisasi/Alamat: ${alamat}\n\nTujuan: ${keperluan}\n\n${isi}\n\nDemikian pengajuan ini kami sampaikan.`;
      break;

    // new templates (Berdasarkan Tujuan)
    case 'surat_dinas':
      title = 'SURAT DINAS';
      body = `Kepada Yth.\n${keperluan}\n${alamat}\n\nDengan hormat,\n\nSehubungan dengan [kegiatan dinas], kami menugaskan:\nNama\t: ${name}\nJabatan\t: ${jab}\n\nUntuk melaksanakan tugas terkait ${isi}.\n\nDemikian surat dinas ini dibuat untuk dapat dilaksanakan sebagaimana mestinya.`;
      break;
    case 'surat_niaga':
      title = 'SURAT NIAGA / KOMERSIAL';
      body = `Kepada Yth.\n${keperluan}\n${alamat}\n\nDengan hormat,\n\nBersama ini kami ajukan penawaran / dokumen komersial:\n[Detail barang / jasa]\n\nKeterangan tambahan:\n${isi}\n\nHormat kami,\n${name}`;
      break;
    case 'surat_pribadi':
      title = 'SURAT PRIBADI';
      body = `Halo ${keperluan || '[Nama]'},\n\n${isi}\n\nSalam hangat,\n${name}`;
      break;
    case 'surat_pemerintahan':
      title = 'SURAT RESMI PEMERINTAHAN';
      body = `Nomor: ${nomor}\nPerihal: ${keperluan}\n\nYth. ${alamat}\n\nDengan hormat,\n\n${isi}\n\nDemikian disampaikan untuk menjadi perhatian.`;
      break;

    // Berdasarkan Bentuk / Format
    case 'surat_resmi':
      title = 'SURAT RESMI';
      body = `[KOP SURAT]\nNomor: ${nomor}\nPerihal: ${keperluan}\n\nKepada Yth.\n${alamat}\n\nDengan hormat,\n\n${isi}\n\nHormat kami,\n${name}`;
      break;
    case 'surat_tidak_resmi':
      title = 'SURAT TIDAK RESMI';
      body = `Hai ${keperluan || '[Nama]'},\n\n${isi}\n\nSalam,\n${name}`;
      break;
    case 'surat_kabar':
      title = 'SIARAN PERS / SURAT BERITA';
      body = `Judul: ${keperluan}\nTanggal: ${tgl}\n\nIsi Berita:\n${isi}\n\nDikeluarkan oleh: ${name}`;
      break;

    // Berdasarkan Isi
    case 'surat_undangan':
      title = 'SURAT UNDANGAN';
      body = `Kepada Yth.\n${alamat}\n\nDengan hormat,\n\nKami mengundang Bapak/Ibu untuk menghadiri:\nAcara: ${keperluan}\n${isi}\n\nHormat kami,\n${name}`;
      break;
    case 'surat_pemberitahuan':
      title = 'SURAT PEMBERITAHUAN';
      body = `Kepada Yth.\n${alamat}\n\nDengan hormat,\n\nBersama surat ini kami sampaikan pemberitahuan:\n${isi}\n\nDiharapkan menjadi perhatian.\n\nHormat kami,\n${name}`;
      break;
    case 'surat_permohonan':
      title = 'SURAT PERMOHONAN';
      body = `Kepada Yth.\n${alamat}\n\nDengan hormat,\n\nSaya yang bertanda tangan di bawah ini:\nNama: ${name}\nJabatan: ${jab}\n\nMengajukan permohonan perihal: ${keperluan}\n\n${isi}\n\nHormat saya,\n${name}`;
      break;
    case 'surat_perjanjian':
      title = 'SURAT PERJANJIAN';
      body = `Pada hari ini, ${tgl}, telah dibuat perjanjian antara:\nPihak Pertama: ${name}\nPihak Kedua: ${alamat}\n\nIsi perjanjian:\n${isi}\n\nDemikian perjanjian ini dibuat dan disetujui kedua belah pihak.`;
      break;
    case 'surat_keputusan':
      title = 'SURAT KEPUTUSAN';
      body = `SURAT KEPUTUSAN\nNomor: ${nomor}\n\nMenetapkan:\n${isi}\n\nDitetapkan oleh: ${name}`;
      break;

    default:
      // fallback (same as formal)
      body = `Kepada Yth.\nPimpinan Instansi yang terkait\nDi Tempat\n\nDengan hormat,\n\nSaya yang bertanda tangan di bawah ini:\nNama\t: ${name}\nJabatan : ${jab}\nAlamat\t: ${alamat}\n\nBermaksud mengajukan: ${keperluan}\n\n${isi}\n\nDemikian permohonan ini saya sampaikan.`;
      break;
  }

  // update title & body
  letterTitle.textContent = title;
  letterBody.textContent = body;
  issuedAt.textContent = `Diterbitkan: ${new Date().toLocaleString()}`;

  // set publisher (editable) — show only if non-empty
  const pub = publisherInput.value.trim();
  if(pub){
    issuedByPreview.textContent = pub;
    issuedByPreview.style.display = 'block';
  } else {
    issuedByPreview.textContent = '';
    issuedByPreview.style.display = 'none';
  }

  // verification: only show if user filled verifInput (as requested)
  const verifStr = verifInput.value.trim();
  if(verifStr){
    verifText.textContent = `Verifikasi: ${verifStr}`;
    barcodeSvg.style.display = 'inline-block';
    verifText.style.display = 'block';
    try {
      JsBarcode("#barcodeSvg", verifStr, {format:"CODE128", width:2, height:40, displayValue:true, fontSize:12});
    } catch(e){
      barcodeSvg.innerHTML = '<text x="10" y="30" fill="#000">'+verifStr+'</text>';
    }
  } else {
    barcodeSvg.innerHTML = '';
    barcodeSvg.style.display = 'none';
    verifText.style.display = 'none';
  }
}

/* helper: format date dd mmm yyyy */
function formatDate(d){
  const dd = String(d.getDate()).padStart(2,'0');
  const mm = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'][d.getMonth()];
  return `${dd} ${mm} ${d.getFullYear()}`;
}

/* nomor generator */
function generateNomor(){
  const d = new Date();
  const y = String(d.getFullYear()).slice(2);
  const m = String(d.getMonth()+1).padStart(2,'0');
  const r = Math.floor(Math.random()*9000)+1000;
  return `GEN/${y}${m}/${r}`;
}

/* Export PDF automatically (generate + download) */
btnExportPDF.addEventListener('click', async ()=>{
  await generatePreview(); // ensure current
  const element = document.getElementById('letterContainer').cloneNode(true);

  // replace barcode svg with image if present
  const svg = element.querySelector('#barcodeSvg');
  if(svg && svg.innerHTML.trim() !== ''){
    try {
      const svgData = new XMLSerializer().serializeToString(document.getElementById('barcodeSvg'));
      const svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);
      const img = document.createElement('img'); img.src = url; img.style.height = '60px';
      svg.parentNode.replaceChild(img, svg);
    } catch(e){}
  }

  // place signature image if exists
  if(lastSignatureDataURL){
    const signDiv = element.querySelector('#signImageLabel');
    if(signDiv){
      signDiv.innerHTML = '<img src="'+lastSignatureDataURL+'" style="max-width:220px;max-height:90px;border:0">';
    }
  }

  const filename = `${(inputKeperluan.value||'surat').toLowerCase().replace(/\s+/g,'_')}_${(new Date()).toISOString().slice(0,10)}.pdf`;

  const opt = {
    margin:       12,
    filename:     filename,
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS: true, allowTaint: true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak:    { mode: ['css', 'legacy'] }
  };

  const wrapper = document.createElement('div');
  wrapper.style.padding = '10mm';
  wrapper.style.background = '#fff';
  wrapper.appendChild(element);

  html2pdf().set(opt).from(wrapper).save();
});

/* Manual Download (same but open print dialog to let user choose) */
btnDownloadManual.addEventListener('click', async ()=>{
  await generatePreview();
  const printable = buildPrintableHTMLString();
  const w = window.open('', '_blank', 'toolbar=0,location=0,menubar=0');
  w.document.open();
  w.document.write(printable);
  w.document.close();
  setTimeout(()=> w.print(), 400);
});

function buildPrintableHTMLString(){
  const el = document.getElementById('letterContainer').cloneNode(true);
  const svg = el.querySelector('#barcodeSvg');
  if(svg && svg.innerHTML.trim() !== ''){
    try {
      const svgData = new XMLSerializer().serializeToString(document.getElementById('barcodeSvg'));
      const svgBlob = new Blob([svgData], {type:"image/svg+xml;charset=utf-8"});
      const url = URL.createObjectURL(svgBlob);
      const img = document.createElement('img'); img.src=url; img.style.height='60px';
      svg.parentNode.replaceChild(img, svg);
    } catch(e){}
  }
  if(lastSignatureDataURL){
    const signDiv = el.querySelector('#signImageLabel');
    if(signDiv) signDiv.innerHTML = '<img src="'+lastSignatureDataURL+'" style="max-width:220px;max-height:90px;border:0">';
  }
  const css = `<style>
    body{font-family: Georgia, serif;color:#111;background:#fff;padding:20px}
    .letter{max-width:800px;margin:0 auto}
    .title{font-size:18px;font-weight:700;margin-bottom:6px}
    .meta{font-size:13px;color:#333;margin-bottom:10px}
    .body{white-space:pre-wrap;font-size:14px;margin-top:12px}
    .sig{margin-top:50px;display:flex;justify-content:space-between;align-items:center}
    img{max-width:100%}
  </style>`;
  return `<!doctype html><html><head><meta charset="utf-8"><title>Surat</title>${css}</head><body>${el.outerHTML}</body></html>`;
}

/* init default date and preview */
(function init(){
  const today = new Date().toISOString().slice(0,10);
  if(!inputTanggal.value) inputTanggal.value = today;
  generatePreview();
})();
</script>
</body>
</html>
